
<html lang="en">
<head>
    <!-- Load Meta -->
    <meta charset="UTF-8">
    <title>Form</title>



    <!-- Lib Stuff - Too lazy to host -->
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    <script data-require="bootstrap@*" data-semver="3.0.0-rc1" src="http://netdna.bootstrapcdn.com/bootstrap/3.0.0-rc1/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="https://www.google.com/jsapi"></script>
    <script src="http://d3js.org/d3.v3.min.js"></script>
    <script src="http://labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js"></script>




    <!-- Slider -->
    <link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/themes/smoothness/jquery-ui.css" />
    <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/jquery-ui.min.js"></script>

    <!-- Table -->
    <link rel="stylesheet" src="http://cdn.rawgit.com/alfajango/jquery-dynatable/master/jquery.dynatable.css" />
    <script src="http://cdn.rawgit.com/alfajango/jquery-dynatable/master/jquery.dynatable.js"></script>


    <!-- Load JS -->
    <script>

console.log(new Date());

var ajax;

var state="California";
var city="Sunnyvale";
var zipcode;
var id;
var name;
var email;

var address;
var leg_id;
var avatar;
var message;
var img_data;

avatar='data:image/png;base64,' + "";

function getBase64Image(imgElem) {
// imgElem must be on the same server otherwise a cross-origin error will be thrown "SECURITY_ERR: DOM Exception 18"
    var canvas = document.createElement("canvas");
    canvas.width = imgElem.clientWidth;
    canvas.height = imgElem.clientHeight;
    var ctx = canvas.getContext("2d");
    ctx.drawImage(imgElem, 0, 0);
    var dataURL = canvas.toDataURL("image/png");
    return dataURL.replace(/^data:image\/(png|jpg);base64,/, "");
}


$(document).ready(function(){

    ajax=new Ajax();


    //     var fwdAPIdomain = 'staging.fwd.us';
    //     var zipCode = '94107';

    //     $.ajax({
    //       dataType: "json",
    //       url: 'https://' + fwdAPIdomain + '/api/v1/legislators/search.json',
    //       data: { zip: zipCode, key: fwdAPIkey },
    //       crossDomain: true,
    //       timeout: 2000,
    //       success: function(data) {
    //         console.log(data);
    //       }
    //     });

    //Enter Overwrite
    $('.noEnterSubmit').keypress(function(e){
    if ( e.which == 13 ) return false;
    //or...
    if ( e.which == 13 ) e.preventDefault();
    });

    //GT
    $(".GT").click(function() {
      console.log("GT");
    });

    //PS
    $(".PS").click(function() {
      console.log("PS");
    });

$( ".Zip" )
  .focusout(function() {
    console.log("A");

    zipcode=$( ".Zip" ).val();
    ajax.searchLegislator(zipcode);

  })
  .blur(function() {
    zipcode=$( ".Zip" ).val();
    ajax.searchLegislator(zipcode);
    console.log("B");
  });

    jQuery.fn.extend({
      disable: function(state) {
          return this.each(function() {
              var $this = $(this);
              if($this.is('input, button'))
                this.disabled = state;
              else
                $this.toggleClass('disabled', state);
          });
      }
    });

    //RD
    $(".FB").click(function() {
        fb_login();
        console.log("FB");
    });



    $("#Image").change(function(){
        console.log("IMAGE************");
        readImage( this );
    });


    $(".SEND").click(function() {
        console.log("SEND");

        name=$( ".Name" ).val();
        email=$( ".Email" ).val();
        address=$( ".Address" ).val();
        zipcode=$( ".Zip" ).val();
        city=$( ".City" ).val();
        state=$( ".State" ).val();
        message=$( ".Message" ).val();

        if(state.length>2){
            state=stateDict[state].toUpperCase();
        }

        if(zipcode.length<5){
            alert("zip invalid");
            return;
        }

        if(zipcode.length<5){
            alert("zip invalid");
            return;
        }

        if(avatar=='data:image/png;base64,'){
            alert("image invalid");
            return;
        }

        // if(leg_id==""){

        //     alert("No valid zip code");
        //     return;
        // }


        ajax.sendFWD();

        // var canvas = document.getElementById('fb_img');
        // console.log(canvas);
        // var imageData  = canvas.toDataURL("image/png");
        //imgData = JSON.stringify(getBase64Image(imgElem));


        //console.log(imgElem);


    //         <div style="width:150px;text-align: center;">
    // <input type="text" class="form-control col-lg-8 find noEnterSubmit Name" placeholder="Name" />
    // <input type="text" class="form-control col-lg-8 find noEnterSubmit Email" placeholder="Email" />
    // <input type="text" class="form-control col-lg-8 find noEnterSubmit Address" placeholder="Address" />
    // <input type="text" class="form-control col-lg-8 find noEnterSubmit Zip" placeholder="Zip" />
    // <input type="text" class="form-control col-lg-8 find noEnterSubmit City" placeholder="City" />
    // <input type="text" class="form-control col-lg-8 find noEnterSubmit State" placeholder="State" />
    // </div>

    // <br>

    // <textarea type="text" class="form-control col-lg-8 find noEnterSubmit Message" placeholder="Message" />
    // This is a message.
    // </textarea>

    });


});

function Ajax(){

    /*
    This class handles the Ajax calls
    */



    var self=this;
    var leg_id;

    var MyRequestsCompleted = (function() {
        var numRequestToComplete,
            requestsCompleted,
            callBacks,
            singleCallBack;
        return function(options) {
            if (!options) options = {};

            numRequestToComplete = options.numRequest || 0;
            requestsCompleted = options.requestsCompleted || 0;
            callBacks = [];
            var fireCallbacks = function () {
                stopSpinner();
                for (var i = 0; i < callBacks.length; i++) callBacks[i]();
            };
            if (options.singleCallback) callBacks.push(options.singleCallback);

            this.addCallbackToQueue = function(isComplete, callback) {
                if (isComplete) requestsCompleted++;
                if (callback) callBacks.push(callback);
                if (requestsCompleted == numRequestToComplete) fireCallbacks();
            };
            this.requestComplete = function(isComplete) {
                if (isComplete) requestsCompleted++;
                if (requestsCompleted == numRequestToComplete) fireCallbacks();
            };
            this.setCallback = function(callback) {
                callBacks.push(callBack);
            };
        };
    })();

    function drawChart() {

    }

    var url="https://app.fwd.us/api/v1/legislators/search";
    var fwdAPIkey = 'f23fe9074cf280314359';

    console.log(stateDict[state]);

    //https://app.fwd.us/api/v1/legislators/search.json?zip=94086&district=&state=&party=&key=f23fe9074cf28014359

    /* Get Conversation GET Call */
    this.searchLegislator = function(zip,callback){
        $.get("https://app.fwd.us/api/v1/legislators/search.json", { "zip":zip, "key":fwdAPIkey , "district":"", "state":"", "party":""})
        .done(function(jsonData) {
            //jsonData = JSON.parse(data);
            console.log("********");
            console.log(jsonData);
            jsonData=jsonData["legislators"];

            rep=jsonData[0];
            img_url=rep["photo"];
            leg_id=rep["id"];
            console.log(leg_id);
            $('#rep_img').html('<img src="'+img_url+'" />');
            //callback(jsonData);

            //then we call this
            //http://api.zippopotam.us/us/ca/sunnyvale

        })
        .fail(function() { console.log("updateTree Error"); })
    }

    this.getProfilePic =function(id,size,callback){
        $.get("https://graph.facebook.com/"+id+"/picture", { "type":size })
        .done(function(data) {
            //jsonData = JSON.parse(data);
            console.log(data);
            //callback(jsonData);

            //then we call this
            //http://api.zippopotam.us/us/ca/sunnyvale

        })
        .fail(function() { console.log("updateTree Error"); })
    }

    this.getB64Img =function(url,callback){
        // $.get(url, { })
        // .done(function(data) {
        //     //jsonData = JSON.parse(data);
        //     console.log("**");
        //     avatar=data;
        //     //callback(jsonData);

        //     //then we call this
        //     //http://api.zippopotam.us/us/ca/sunnyvale

        // })
        // .fail(function() { console.log("getB64Img Error"); })



                $.ajax({
            dataType: 'text',
            type: 'get',
            url: url,
            data: {
                },
            crossDomain: true,

        })
        .done(function(data) {
            //jsonData = JSON.parse(data);
            console.log("IMAGE SUCCESS");
            avatar='data:image/png;base64,' + data;

        })
        .fail(function() { console.log("IMAGE Error"); })

    }

    this.sendFWD =function(callback){

        //state make caps

//         selfie[name]:Raaj
// selfie[email]:raaj@raaj.com
// selfie[zip]:94086
// selfie[street_address]:geeg
// selfie[city]:Sunnyvale
// selfie[state]:CA
// selfie[legislator_id]:H001034
// selfie[message]:ergfwefwefwefwefwefwefwefewfwf wefwefwefwefwefwef efwegergergerg
// selfie[avatar]:

    console.log(state);



        $.ajax({
            dataType: 'json',
            type: 'post',
            url: "https://app.fwd.us/api/v1/selfies.json",
            data: {
                "key":fwdAPIkey,
                "selfie[name]":name,
                "selfie[email]":email,
                "selfie[zip]":zipcode,
                "selfie[street_address]":address,
                "selfie[city]":city,
                "selfie[state]":state.toUpperCase(),
                "selfie[legislator_id]":leg_id,
                "selfie[avatar]":avatar,
                "selfie[message]":$('.Message').val()},
            crossDomain: true,

        })
        .done(function(data) {
            //jsonData = JSON.parse(data);
            console.log("SELFIE SUCCESS");
            console.log(data);

            alert("Your selfie was sent!");
            //callback(jsonData);

            //then we call this
            //http://api.zippopotam.us/us/ca/sunnyvale

        })
        .fail(function() {

            console.log("sendFWD Error");
            alert("One of your fields has an issue");


        })

        console.log(name);
        console.log(email);
        console.log(zipcode);
        console.log(address);
        console.log(city);
        console.log(state);
        console.log(leg_id);
        console.log($('.Writing').val());


        $.ajax({
            dataType: 'json',
            type: 'post',
            url: "https://app.fwd.us/api/v1/letters.json",
            data: {
                "key":fwdAPIkey,
                "letter[name]":name,
                "letter[email]":email,
                "letter[zip]":zipcode,
                "letter[street_address]":address,
                "letter[city]":city,
                "letter[state]":state.toUpperCase(),
                "letter[legislator_id]":leg_id,
                "letter[shareable]":false,
                "letter[writing]":$('.Writing').val()},

            crossDomain: true,

        })
        .done(function(data) {
            //jsonData = JSON.parse(data);
            console.log("LETTERS SUCCESS");
            console.log(data);

            alert("Your letter was sent!");
            //callback(jsonData);

            //then we call this
            //http://api.zippopotam.us/us/ca/sunnyvale

        })
        .fail(function() { console.log("sendFWD Error"); alert("One of your fields has an issue"); })
    }


}

     stateDict=
    {
        "Alabama": "al",
        "Alaska": "ak",
        "American Samoa": "as",
        "Arizona": "az",
        "Arkansas": "ar",
        "California": "ca",
        "Colorado": "co",
        "Connecticut": "ct",
        "Delaware": "de",
        "District Of Columbia": "dc",
        "Federated States Of Micronesia": "fm",
        "Florida": "fl",
        "Georgia": "ga",
        "Guam": "gu",
        "Hawaii": "hi",
        "Idaho": "id",
        "Illinois": "il",
        "Indiana": "in",
        "Iowa": "ia",
        "Kansas": "ks",
        "Kentucky": "ky",
        "Louisiana": "la",
        "Maine": "me",
        "Marshall Islands": "mh",
        "Maryland": "md",
        "Massachusetts": "ma",
        "Michigan": "mi",
        "Minnesota": "mn",
        "Mississippi": "ms",
        "Missouri": "mo",
        "Montana": "mt",
        "Nebraska": "ne",
        "Nevada": "nv",
        "New Hampshire": "nh",
        "New Jersey": "nj",
        "New Mexico": "nm",
        "New York": "ny",
        "North Carolina": "nc",
        "North Dakota": "nd",
        "Northern Mariana Islands": "mp",
        "Ohio": "oh",
        "Oklahoma": "ok",
        "Oregon": "or",
        "Palau": "pw",
        "Pennsylvania": "pa",
        "Puerto Rico": "pr",
        "Rhode Island": "ri",
        "South Carolina": "sc",
        "South Dakota": "sd",
        "Tennessee": "tn",
        "Texas": "tx",
        "Utah": "ut",
        "Vermont": "vt",
        "Virgin Islands": "vi",
        "VA": "Virginia",
        "WA": "Washington",
        "WV": "West Virginia",
        "WI": "Wisconsin",
        "WY": "Wyoming"
    };

 // This is called with the results from from FB.getLoginStatus().
  function statusChangeCallback(response) {
    console.log('statusChangeCallback');
    console.log(response);
    // The response object is returned with a status field that lets the
    // app know the current login status of the person.
    // Full docs on the response object can be found in the documentation
    // for FB.getLoginStatus().
    if (response.status === 'connected') {
      // Logged into your app and Facebook.
      testAPI();
    } else if (response.status === 'not_authorized') {
      // The person is logged into Facebook, but not your app.
      document.getElementById('status').innerHTML = 'Please log ' +
        'into this app.';
    } else {
      // The person is not logged into Facebook, so we're not sure if
      // they are logged into this app or not.
      document.getElementById('status').innerHTML = 'Please log ' +
        'into Facebook.';
    }
  }

  // This function is called when someone finishes with the Login
  // Button.  See the onlogin handler attached to it in the sample
  // code below.
  function checkLoginState() {
    FB.getLoginStatus(function(response) {
      statusChangeCallback(response);
    });
  }

  window.fbAsyncInit = function() {
  FB.init({
    appId      : '649737755119180',
    cookie     : true,  // enable cookies to allow the server to access
                        // the session
    xfbml      : true,  // parse social plugins on this page
    version    : 'v2.0' // use version 2.0
  });




//   // Now that we've initialized the JavaScript SDK, we call
//   // FB.getLoginStatus().  This function gets the state of the
//   // person visiting this page and can return one of three states to
//   // the callback you provide.  They can be:
//   //
//   // 1. Logged into your app ('connected')
//   // 2. Logged into Facebook, but not your app ('not_authorized')
//   // 3. Not logged into Facebook and can't tell if they are logged into
//   //    your app or not.
//   //
//   // These three cases are handled in the callback function.

      FB.getLoginStatus(function(response) {
        statusChangeCallback(response);
      });

  };

  // Load the SDK asynchronously
(function(d, s, id) {
    var js, fjs = d.getElementsByTagName(s)[0];
    if (d.getElementById(id)) return;
    js = d.createElement(s); js.id = id;
    js.src = "http://connect.facebook.net/en_US/sdk.js";
    fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));


button=0;

  // Here we run a very simple test of the Graph API after login is
  // successful.  See statusChangeCallback() for when this call is made.
function testAPI() {
    console.log('Welcome!  Fetching your information.... ');

    FB.api('/me?fields=id,name,location,hometown,email', function(response) {

      //Second round it goes here

      console.log('Successful login for: ' + response.name);
      document.getElementById('status').innerHTML =
        'Thanks for logging in, ' + response.name + '!';

        loc=response.location.name;
        arr=loc.split(", ");
        state=arr[1];
        city=arr[0];
        id=response.id;
        name=response.name;
        email=response.email;
        console.log(state);
        console.log(city);
        console.log(response);

        zip_code();


    });
}

function zip_code(){
                var url='http://api.zippopotam.us/us/'+stateDict[state]+'/'+city;
            console.log(url);
            jQuery.ajax({
                 url:   url,
                 success: function(result) {
                    console.log(result);
                    // jsonData = JSON.parse(result);
                    places=result["places"];
                    zipcode=places[0]["post code"];
                    console.log("ZIPCODE SET** : "+zipcode);

                    ajax.searchLegislator(zipcode);

                    img_url="https://graph.facebook.com/"+id+"/picture?type=large";
                    avatar=img_url;
                    console.log(img_url);
                    ajax.getB64Img(img_url);
                    $('#fb_img').html('<img src="'+img_url+'" />');


                    $(".Zip").attr("value", zipcode);
                    $(".Name").attr("value", name);
                    $(".Email").attr("value", email);
                    $(".City").attr("value", city);
                    $(".State").attr("value", state);

                    $(".Address").attr("value", "Sample Address goes here");

                    },
                 async:   false
            });
}

function fb_login(){
    button=1;
    FB.login(function(response) {

        if (response.authResponse) {
            console.log('Welcome!  Fetching your information.... ');

                console.log(button);
                if(button==1){
                  console.log("*********")
                  // button=0;
                  // //location.reload();
                  window.location.reload(false);
                  // console.log("RELOAD")
                  // return;
                }

            //console.log(response); // dump complete info
            access_token = response.authResponse.accessToken; //get access token
            user_id = response.authResponse.userID; //get FB UID

            FB.api('/me?fields=id,name,location,hometown,email', function(response) {
                user_email = response.email; //get user email
          // you can store this data into your database
            });

        } else {
            //user hit cancel button
            console.log('User cancelled login or did not fully authorize.');

        }
    }, {
        scope: 'user_location,user_hometown'
    });
}


function readImage(input) {
    // if ( input.files && input.files[0] ) {
    //     var FR= new FileReader();
    //     FR.onload = function(e) {
    //          $('#img').attr( "src", e.target.result );
    //          $('#base').text( e.target.result );
    //     };
    //     FR.readAsDataURL( input.files[0] );
    // }

    var files=input.files;
    var file=input.files[0];

    if (files && file) {
        var reader = new FileReader();

        reader.onload = function(readerEvt) {
            $('#blah').attr('src', readerEvt.target.result);

            var binaryString = readerEvt.target.result;
            img_data=btoa(binaryString);
            console.log(img_data);
            avatar='data:image/png;base64,' + img_data;
        };

        reader.readAsDataURL(file);
        reader.readAsBinaryString(file);
    }
}

    </script>




</head>
<body>

<!-- NavBar -->
<div class="navbar">
  <div class="container">

    <!-- NavBar -->
    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-inverse-collapse">
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
    </button>

    <!-- Logo -->
    <hidden a class="navbar-brand" href="#">
    <img alt="img.png" src="img.png" width="20%" height="5%"/>
    Immigrowth
    </a>

    <div class="nav-collapse collapse navbar-inverse-collapse">

        <div hidden id="uptime" style="float:right;padding-top:20px;color: gray;font-size:15px; font-style:italic">
        Changing immigration reform one target market at a time
        </div>

    </div><!-- /.nav-collapse -->
  </div><!-- /.container -->
</div>

<br>

<!-- Facebook -->
<center>

    <button type="button" class="btn btn-lg FB">
    Login with FB
    </button>

<!--     <fb:login-button scope="public_profile,email" onlogin="checkLoginState();">
    </fb:login-button> -->

    <div id="status">
    </div>

    <br>

    <div id="fb_img" class="">
    </div>

    <br>

    <div id="rep_img" class="">

    </div>


    <img id="blah" src="#" alt="your image" />

    <br>

    <div style="width:150px;text-align: center;">
    <input type="text" class="form-control col-lg-8 find noEnterSubmit Name" placeholder="Name" />
    <input type="text" class="form-control col-lg-8 find noEnterSubmit Email" placeholder="Email" />
    <input type="text" class="form-control col-lg-8 find noEnterSubmit Address" placeholder="Address" />
    <input type="text" class="form-control col-lg-8 find noEnterSubmit Zip" placeholder="Zip" />
    <input type="text" class="form-control col-lg-8 find noEnterSubmit City" placeholder="City" />
    <input type="text" class="form-control col-lg-8 find noEnterSubmit State" placeholder="State" />
    <br>Upload a picture of yourself: <input type="file" name="datafile" class="Image" id="Image"/>
    </div>
    

    <br>

    <textarea hidden type="text" class="form-control col-lg-8 find noEnterSubmit Message" placeholder="Message" />
    I support immigration reform! #FWD.us
    </textarea>
    <textarea hidden type="text" class="form-control col-lg-8 find noEnterSubmit Writing" placeholder="Writing" />
    Dear Congressional Representative, I am a supporter of immigration reform. I believe that it is important for the United States to bring in top technical talent from other countries who can help grow our technology and knowledge economy and make the United States a better place. Currently it can be hard for immigrants to come to the country and establish themselves here. We should make the process easier for such individuals. We need members of Congress to understand that this is an important initiative. Top talent and smart immigrants can implement new ideas in America and provide jobs. Please don't forget that immigrants are the backbone of our nation.
    </textarea>

    <br>

    <button type="button" class="btn btn-lg SEND">
    Send
    </button>


</center>


</body>
</html>
